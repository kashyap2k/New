# NeetLogIQ Configuration File
# Externalized configuration for all matching and processing parameters

# Database Configuration
database:
  # SQLite (Development)
  sqlite_path: "data/sqlite"
  master_data_db: "master_data.db"
  counselling_data_db: "counselling_data_partitioned.db"
  aiq_counselling_db: "AIQ_counselling_data.db"
  kea_counselling_db: "KEA_counselling_data.db"
  linked_data_db: "linked_data.db"
  seat_data_db: "seat_data.db"
  
  # Connection pool size (should match thread count for optimal performance)
  max_connections: 16  # Match num_processes for best performance
  
  # PostgreSQL (Local Development)
  local_postgresql_url: "postgresql://kashyapanand@localhost:5432/neetlogiq"
  
  # PostgreSQL (Production - Neon)
  neon_url: "postgresql://neondb_owner:npg_EZFqn57Jjgml@ep-little-frog-a8v5n24y-pooler.eastus2.azure.neon.tech/neondb?sslmode=require&channel_binding=require"
  # Example: "postgresql://user:pass@ep-cool-darkness-123456.us-east-2.aws.neon.tech/neetlogiq"

# Redis Cache Configuration (100x speedup on cache hits)
redis:
  enabled: true              # Set to true to enable Redis caching
  auto_start: true           # Auto-start Redis with script, auto-stop on exit
  host: localhost            # Redis server hostname
  port: 6379                 # Redis server port (default: 6379)
  db: 0                      # Redis database number (0-15)
  # Optional settings:
  # password: ""             # Redis password (if required)
  # socket_timeout: 5        # Socket timeout in seconds
  # connection_pool_size: 10 # Max connections in pool

# Matching Configuration
matching:
  # CRITICAL: Address validation (prevents false matches)
  enable_address_validation: true  # MANDATORY validation to prevent different colleges matching same ID
  min_address_score: 0.3           # Minimum address similarity (30% = more lenient, 50% = stricter)
  
  # Smart Hybrid Matching Configuration
  use_smart_hybrid: true           # Enable smart hybrid matching (fast path + AI fallback)
  hybrid_threshold: 70.0            # Score threshold for accepting fast match (70% = more lenient, 85% = stricter)
  
  # PASS 2 Alias Matching Configuration
  enable_pass2_alias_matching: false  # Set to false to run only PASS 1 (disable alias matching in PASS 2)

# Smart Address Matching Configuration
address_matching:
  # Enable smart semantic matching (uses transformers/embeddings)
  enable_smart_matching: true        # Use semantic + ensemble + adaptive matching
  
  # Semantic matching (requires sentence-transformers)
  use_semantic_matching: true        # Use embeddings for address similarity
  semantic_weight: 0.4               # Weight for semantic matching in ensemble
  
  # Keyword matching
  keyword_weight: 0.2                # Weight for keyword matching in ensemble
  
  # Fuzzy matching
  fuzzy_weight: 0.1                  # Weight for fuzzy matching in ensemble
  
  # Context-aware matching (combines name + address + state)
  context_weight: 0.3                # Weight for context-aware matching in ensemble
  
  # Confidence thresholds
  min_confidence_generic: 0.6        # Minimum confidence for generic names
  min_confidence_specific: 0.4       # Minimum confidence for specific names
  
  # Address quality thresholds
  generic_address_threshold: 0.7     # Stricter threshold for generic addresses
  partial_address_threshold: 0.5     # More lenient for partial addresses
  
  # Pattern learning
  enable_pattern_learning: true      # Learn from successful matches
  min_matches_for_learning: 10       # Minimum matches to learn patterns

  # Score thresholds for different matching methods
  thresholds:
    exact: 100
    high_confidence: 90
    medium_confidence: 80
    low_confidence: 75
    exact_match: 1.0
    normalized_match: 0.95
    fuzzy_match: 0.50
    substring_match: 0.70
    partial_word_match: 0.75
    tfidf_match: 0.80

  # Minimum confidence for accepting a match
  min_confidence: 0.50

  # Maximum number of candidates to consider
  max_candidates: 10

  # Enable/disable different matching strategies
  strategies:
    exact: true
    normalized: true
    fuzzy: true
    substring: true
    partial_word: true
    tfidf: true

# Matching Path Configuration - Enable/Disable Specific Paths for Debugging
matching_paths:
  # Enable/disable specific matching paths for debugging and testing
  enable_smart_hybrid: true          # match_college_smart_hybrid() - Fast path + AI fallback
  enable_enhanced: true              # match_college_enhanced() - Standard matching with routing
  enable_ultra_optimized: true      # match_college_ultra_optimized() - Fast path for pre-normalized data
  enable_ai_enhanced: true           # match_college_ai_enhanced() - AI-enhanced matching
  enable_regular_course: true       # match_regular_course() - Regular course matching
  enable_overlapping_diploma: true   # match_overlapping_diploma_course() - Overlapping diploma courses
  enable_medical_only_diploma: true  # match_medical_only_diploma_course() - Medical-only diploma courses

# Feature Toggles - Enable/Disable Advanced Features
features:
  # Performance Optimizations
  enable_phonetic_cache: true        # Cache phonetic keys for faster lookups
  enable_tfidf_cache: true           # Cache TF-IDF similarity scores
  enable_parallel_phonetic: true     # Use parallel processing for phonetic matching (20+ candidates)

  # AI/ML Features
  enable_vector_search: false        # FAISS vector search (may cause segfaults on macOS - set to false if crashes)

  # NEW 2025 ADVANCED FEATURES
  enable_soft_tfidf: true            # Soft TF-IDF: typo-tolerant matching with n-grams (2-5% accuracy boost)
  enable_xai: true                   # Explainable AI: Generate human-readable explanations for matching decisions
  log_xai_explanations: true        # Log XAI explanations to console (set to true for debugging)
  enable_ensemble_voting: true       # Ensemble matcher: weighted voting across fuzzy+phonetic+TF-IDF (5-8% accuracy boost)
  enable_explainable_ai: true        # Explainable AI: human-readable match explanations with component breakdown
  enable_uncertainty_quantification: true  # Uncertainty quantification: confidence intervals and agreement metrics

  # Smart Matching Enhancements
  enable_smart_retry: true           # Auto-retry failed matches with phonetic fallback
  enable_ml_boost: false             # Boost fuzzy matches with ML confidence (requires trained model)
  enable_historical_context: false   # Use historical match patterns (requires 100+ matched records)

  # Interactive Review Enhancements
  enable_auto_suggest: true          # Auto-suggest aliases for high-confidence matches (≥90%)
  auto_suggest_threshold: 90         # Minimum confidence % for auto-suggestions

  # Batch Operations
  enable_batch_operations: true      # Show batch operations menu after matching

  # Link Table Management
  enable_auto_rebuild_links: true    # Auto-rebuild college_course_link and state_course_college_link_text after matching
  enable_auto_historical_build: true # Auto-build historical context from successful matches (requires 100+ records)
  enable_auto_validate_integrity: true # Auto-validate data integrity after matching (detects false matches)

  # Location-Aware Matching
  enable_location_aware_aliases: true  # Use state+address for alias matching

  # Validation & Quality
  enable_stream_validation: true     # Validate college-course stream compatibility
  enable_state_validation: true      # Validate college-state consistency

  # NEW ADVANCED FEATURES (2025)
  enable_advanced_blocking: true     # Multi-key blocking (10-20x speedup)
  enable_stream_processing: true    # Real-time stream processing with directory watching
  enable_domain_embeddings: true     # Fine-tune sentence-transformers on medical corpus
  enable_gnn_matching: false          # Graph Neural Networks - DISABLED: TypeError with NoneType addresses

# Stream Processing Configuration
stream:
  watch_directory: null              # Directory to watch for new files (null = disabled, set to path to enable watching)
  buffer_size: 100                   # Records to buffer before batch processing

# Graph Neural Network Configuration
gnn:
  input_dim: 128                     # Input feature dimension
  hidden_dim: 64                     # Hidden layer dimension
  output_dim: 32                     # Output embedding dimension

# Domain Embeddings Configuration
domain_embeddings:
  base_model: "all-MiniLM-L6-v2"     # Base sentence-transformer model
  fine_tuned_path: "models/fine_tuned_embeddings"  # Path to save fine-tuned model
  epochs: 10                         # Training epochs for fine-tuning
  auto_fine_tune: true              # Auto fine-tune on initialization (set to false to disable)

# Validation Configuration
validation:
  strictness: moderate  # strict | moderate | lenient
  
  # Generic Name Detection
  # DISABLED: Generic name detection was incorrectly classifying specific colleges as generic
  # For example, "RAJASTHAN DENTAL COLLEGE AND HOSPITAL" was being classified as generic
  # because "RAJASTHAN" (a state name) was the only non-generic term.
  # When disabled, all colleges are treated as specific names with lenient matching rules
  enable_generic_name_detection: false  # Set to false to disable generic name detection
  
  # Address Validation Configuration
  address_validation:
    enabled: true                      # Enable address validation gate
    require_for_generic_names: true    # Require address validation for generic college names
    require_for_single_candidate: true  # Require address validation when narrowed to single candidate
    min_address_similarity_generic: 0.4   # 40% minimum address overlap for generic names
    min_address_similarity_specific: 0.2  # 20% minimum address overlap for specific names
    combined_score_threshold: 0.85       # 85% combined confidence required
    address_weight_exact: 0.3            # 30% weight for exact matches
    address_weight_primary: 0.3         # 30% weight for primary name matches
    address_weight_prefix: 0.4           # 40% weight for prefix matches
    address_weight_fuzzy: 0.4            # 40% weight for fuzzy matches
    
  # Generic Name Detection (only used if enable_generic_name_detection: true)
  generic_name_terms:
    - GOVERNMENT
    - MEDICAL
    - COLLEGE
    - DENTAL
    - INSTITUTE
    - HOSPITAL
    - UNIVERSITY
    - HOSPITAL
  generic_name_max_non_generic_terms: 2  # Max non-generic terms to be considered generic

  # Analytics & Reporting
  enable_analytics_dashboard: true   # Generate match quality analytics
  enable_auto_historical_build: true # Auto-build historical context after 100+ matches

# TF-IDF Configuration
tfidf:
  # Maximum features for TF-IDF vectorizer
  max_features: 1000
  
  # N-gram range for TF-IDF
  ngram_range: [1, 2]
  
  # Minimum document frequency
  min_df: 1
  
  # Maximum document frequency
  max_df: 0.95
  
  # Whether to use stop words
  use_stop_words: true

# Parallel Processing Configuration
parallel:
  # Number of threads for parallel processing (uses ThreadPoolExecutor)
  # FIXED: Changed from ProcessPoolExecutor to ThreadPoolExecutor
  # Result: 40min → ~5min for 57K records (8x faster!)
  # Recommended: 8-16 threads for best performance
  # OPTIMIZED: Increased from 8 to 16 for better performance
  num_processes: 16

  # Batch size for processing (records per batch)
  # Larger = less overhead, more memory. Smaller = more granular progress
  # Recommended: 1000-2000 for most datasets
  # OPTIMIZED: Reduced from 2000 to 1000 for better thread utilization
  batch_size: 1000
  
  # Memory limit per process (MB)
  memory_limit: 512

# String Normalization Configuration
normalization:
  # OCR Error Cleanup (for PDF-to-Excel conversion errors)
  # DISABLED: OCR cleanup was removing spaces between acronyms and words (e.g., "GSL DENTAL" → "GSLDENTAL")
  # This caused issues with generic name detection and address matching
  clean_ocr_errors: false      # Fix spaces within words (e.g., "COLLEG E" → "COLLEGE", "DENTIST RY" → "DENTISTRY")

  # Basic settings
  to_uppercase: true
  normalize_whitespace: true
  remove_pincodes: true
  handle_hyphens_dots: true

  # ⚠️ IMPORTANT: Set to false to use selective character handling below
  # Old behavior (true) removes ALL special chars except alphanumeric, spaces, commas, parentheses
  # New behavior (false) uses smart replacement and selective preservation
  remove_special_chars: false

  # Smart character preservation
  # These characters will be KEPT in the text
  preserve_chars:
    - "'"   # Apostrophe (e.g., JOHN'S → JOHNS)
    - "-"   # Hyphen (for compound words like POST-GRADUATE)
    - "+"   # Plus sign (e.g., M+CH)
    # Note: Commas are ALWAYS preserved (required for address splitting)

  # Smart character replacement
  # These characters will be REPLACED before normalization
  replace_chars:
    "&": " AND "    # Ampersand → AND (e.g., COLLEGE & HOSPITAL → COLLEGE AND HOSPITAL)
    "/": " "        # Slash → space (e.g., OB/GYN → OB GYN, MD/MS → MD MS)
    "\\": " "       # Backslash → space

  # Context-aware features
  context_aware:
    medical_degrees: true      # Normalize M.B.B.S → MBBS, B.D.S → BDS, M.D. → MD, etc.
    possessives: true          # Keep apostrophe-s recognizable
    compound_words: true       # Handle hyphenated words properly

  # Punctuation correction
  fix_punctuation:
    remove_double_commas: true         # ,, → , (fixes "COLLEGE,, ADDRESS" → "COLLEGE, ADDRESS")
    remove_double_dots: true           # .. → . (fixes "TEXT.." → "TEXT.")
    remove_leading_punctuation: true   # Remove leading space/comma/dot (fixes "  , TEXT" → "TEXT")
    remove_trailing_punctuation: true  # Remove trailing space/comma/dot (fixes "TEXT,," → "TEXT")

# Abbreviation Expansion Configuration
# Add or modify abbreviations as needed for your data
abbreviations:
  GOVT: GOVERNMENT
  MED: MEDICAL
  COLL: COLLEGE
  INST: INSTITUTE
  UNIV: UNIVERSITY
  DIST: DISTRICT
  HOSP: HOSPITAL
  GEN: GENERAL
  SCH: SCHOOL
  DEPT: DEPARTMENT
  MIN: MINORITY
  PVT: PRIVATE
  MGMT: MANAGEMENT
  TECH: TECHNOLOGY
  ESI: EMPLOYEES STATE INSURANCE
  ESIC: EMPLOYEES STATE INSURANCE CORPORATION
  AIIMS: ALL INDIA INSTITUTE OF MEDICAL SCIENCES
  JIPMER: JAWAHARLAL INSTITUTE OF POSTGRADUATE MEDICAL EDUCATION AND RESEARCH
  PGIMER: POST GRADUATE INSTITUTE OF MEDICAL EDUCATION AND RESEARCH
  SCI: SCIENCE
  SCE: SCIENCE
  RES: RESEARCH
  INSTT: INSTITUTE
  INSTITUE: INSTITUTE  # Common typo

# Course Classification Configuration
course_classification:
  # Check DNB patterns first (most specific - DNB- should be checked before DIPLOMA)
  dnb_patterns:
    - "DNB-"
    - "DNB"
  
  # Check dental patterns second (most specific)
  dental_patterns:
    - "BDS"
    - "MDS"
    - "PG DIPLOMA"
    - "DENTAL"
  
  # Check medical patterns last (includes DIPLOMA)
  medical_patterns:
    - "MBBS"
    - "MD"
    - "MS"
    - "MD/MS"
    - "MPH"
    - "DIPLOMA"
    - "POST MBBS"
    - "DM"
    - "MCH"
    - "ALL PG COURSES"

# State Name Normalization
state_normalization:
  mappings:
    "DELHI (NCT)": "DELHI (NCT)"
    "NEW DELHI": "DELHI (NCT)"
    "DELHI": "DELHI (NCT)"
    "ORISSA": "ODISHA"
    "JAMMU AND KASHMIR": "JAMMU AND KASHMIR"
    "ANDHRA PRADESH": "ANDHRA PRADESH"
    "ARUNACHAL PRADESH": "ARUNACHAL PRADESH"
    "ASSAM": "ASSAM"
    "BIHAR": "BIHAR"
    "CHHATTISGARH": "CHHATTISGARH"
    "GOA": "GOA"
    "GUJARAT": "GUJARAT"
    "HARYANA": "HARYANA"
    "HIMACHAL PRADESH": "HIMACHAL PRADESH"
    "JHARKHAND": "JHARKHAND"
    "KARNATAKA": "KARNATAKA"
    "KERALA": "KERALA"
    "MADHYA PRADESH": "MADHYA PRADESH"
    "MAHARASHTRA": "MAHARASHTRA"
    "MANIPUR": "MANIPUR"
    "MEGHALAYA": "MEGHALAYA"
    "MIZORAM": "MIZORAM"
    "NAGALAND": "NAGALAND"
    "PUNJAB": "PUNJAB"
    "RAJASTHAN": "RAJASTHAN"
    "SIKKIM": "SIKKIM"
    "TAMIL NADU": "TAMIL NADU"
    "TELANGANA": "TELANGANA"
    "TRIPURA": "TRIPURA"
    "UTTAR PRADESH": "UTTAR PRADESH"
    "UTTARAKHAND": "UTTARAKHAND"
    "WEST BENGAL": "WEST BENGAL"

# Logging Configuration
logging:
  # Console output verbosity control
  console_level: "WARNING"  # WARNING (minimal), INFO (moderate), DEBUG (verbose)
  file_level: "INFO"        # Log level for file output

  # Verbosity level for performance monitoring and progress display
  # 0 = quiet (only errors), 1 = normal (progress bars only), 2 = verbose (detailed logs), 3 = debug (all logs)
  verbosity_level: 1

  # Progress bar settings
  show_progress_bars: true   # Show tqdm progress bars during batch processing
  progress_bar_style: "auto" # auto, simple, detailed

  # Performance monitoring
  show_slow_operation_warnings: false  # Show warnings for operations taking >1 second (only if verbosity_level >= 2)

  # Detailed matching diagnostic messages
  verbose_matching: false   # Show detailed rejection reasons for low-confidence matches
  verbose_overlap: false    # Show token overlap analysis for rejected matches

  # Legacy settings (kept for compatibility)
  level: "INFO"
  format: "%(asctime)s - %(levelname)s - %(message)s"
  file: "logs/neetlogiq.log"
  max_size: "10MB"
  backup_count: 5

# Human-in-the-Loop Configuration
human_feedback:
  # Enable interactive mode
  interactive_mode: true
  
  # Show top N matches for manual review
  top_matches: 5
  
  # Minimum confidence for manual review
  min_confidence_for_review: 0.60
  
  # Save manual corrections to database
  save_corrections: true

# DIPLOMA Course Classification
diploma_courses:
  # DNB-only courses (only offered in DNB stream)
  dnb_only:
    - "DIPLOMA IN FAMILY MEDICINE"
  
  # Overlapping courses (offered in both MEDICAL and DNB streams)
  overlapping:
    - "DIPLOMA IN ANAESTHESIOLOGY"
    - "DIPLOMA IN OBSTETRICS AND GYNAECOLOGY"
    - "DIPLOMA IN OPHTHALMOLOGY"
    - "DIPLOMA IN OTORHINOLARYNGOLOGY"
  
  # Note: All other DIPLOMA courses default to 'medical' type

# Aliases Configuration
aliases:
  # College name aliases
  college_aliases:
    "CENTRE": "CENTER"
    "KOVAI MEDICAL CENTRE": "KOVAI MEDICAL CENTER AND HOSPITAL"
    "KIMS SUNSHINE HOSPITAL (FORMERLY KNOWN AS SUNSHINE HOSPITAL)": "KIMS SUNSHINE HOSPITAL (SUNSHINE HOSPITAL)"
    "ISLAMPUR SDH/ ISSH": "ISLAMPUR SUPER SPECIALTY HOSPITAL"
    "AIIMS": "ALL INDIA INSTITUTE OF MEDICAL SCIENCES"
    "JIPMER": "JAWAHARLAL INSTITUTE OF POSTGRADUATE MEDICAL EDUCATION AND RESEARCH"
  
  # Course name aliases
  course_aliases:
    "MD IN ANAESTHESIA": "MD IN ANAESTHESIOLOGY"
    "MCH IN CARDIOTHORACIC SURGERY": "MCH IN CARDIO VASCULAR AND THORACIC SURGERY"
    "DIPLOMA IN OTORHINOLARYNGOLOGY": "DIPLOMA IN ENT"
    "DNB IN OTORHINOLARYNGOLOGY": "DNB IN ENT"
    "DNB- DIPLOMA IN RADIO DIAGNOSIS NMDR": "DNB- DIPLOMA IN RADIO DIAGNOSIS"

# ==================== PHASE 2 PERFORMANCE OPTIMIZATIONS ====================
# Advanced filtering and vector search optimizations (5-100x speedup)
phase2_optimizations:
  # Enable multi-stage filtering for candidate reduction (200 → 10-20 candidates)
  enable_multi_stage_filter: true

  # Enable ANN (Approximate Nearest Neighbors) for fast vector search
  enable_ann_search: false  # DISABLED: 'ApproximateNNIndex' object has no attribute 'build'

  # Multi-stage filter thresholds (conservative for high recall)
  multi_stage_filter:
    min_token_overlap: 0.3      # 30% token overlap required
    min_ngram_overlap: 0.35     # 35% n-gram overlap required
    min_char_similarity: 0.4    # 40% character similarity required
    length_tolerance: 0.5       # 50% length difference tolerated
    use_phonetic: true          # Use phonetic matching (Metaphone, NYSIIS)
    use_location_boost: true    # Boost candidates from same location

    # Auto-adjustment settings
    min_candidates_threshold: 3  # Min candidates before auto-loosening thresholds
    threshold_decay: 0.7         # Factor to loosen thresholds by (0.7 = 30% looser)

  # ANN index configuration
  ann_index:
    index_type: "auto"           # "faiss", "annoy", or "auto" (tries FAISS → Annoy → linear)
    dimension: 384               # Embedding dimension (384 for all-MiniLM-L6-v2)
    n_trees: 10                  # Number of trees for Annoy index (more = more accurate, slower build)
    search_k: 50                 # Search parameter for Annoy (higher = more accurate, slower)
    n_clusters: 100              # Number of clusters for FAISS IVF index
    n_probe: 10                  # Number of clusters to search in FAISS
    index_path: "data/ann_index.bin"  # Path to save/load index

# Export Configuration
export:
  # Output directory
  output_dir: "data"

  # Export statistics
  export_stats: true
